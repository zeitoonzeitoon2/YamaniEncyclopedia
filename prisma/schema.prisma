// Prisma schema for SITEMAN

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Models (استفاده از String به‌جای enum برای سازگاری و سادگی)

model Domain {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?

  parentId    String?
  parent      Domain?  @relation("DomainHierarchy", fields: [parentId], references: [id])
  children    Domain[] @relation("DomainHierarchy")

  experts     DomainExpert[]
  expertCandidacies ExpertCandidacy[]
  electionRounds    ElectionRound[]
  courses     Course[]
  domainRequirements DomainRequirement[]
  researchPrerequisites DomainPrerequisite[]
  posts       Post[]

  votingShares      DomainVotingShare[] @relation("DomainShares")
  ownedShares       DomainVotingShare[] @relation("OwnedShares")
  proposedInvestments DomainInvestment[] @relation("ProposedInvestments")
  receivedInvestments DomainInvestment[] @relation("ReceivedInvestments")
  investedInvestments DomainInvestment[] @relation("InvestedInvestments")
  targetedProposals DomainProposal[] @relation("TargetedProposals")
  exchangeProposalsProposed DomainExchangeProposal[] @relation("ProposedExchanges")
  exchangeProposalsReceived DomainExchangeProposal[] @relation("ReceivedExchanges")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([parentId])
}

model DomainExpert {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  domainId  String
  domain    Domain   @relation(fields: [domainId], references: [id])
  role      String   @default("EXPERT")
  wing      String   @default("RIGHT") // RIGHT or LEFT
  createdAt DateTime @default(now())

  @@unique([userId, domainId])
  @@index([domainId])
  @@index([userId])
}

model ExpertCandidacy {
  id              String         @id @default(cuid())
  domainId         String
  domain           Domain         @relation(fields: [domainId], references: [id])
  candidateUserId  String
  candidateUser    User           @relation("ExpertCandidacyCandidate", fields: [candidateUserId], references: [id])
  proposerUserId   String
  proposerUser     User           @relation("ExpertCandidacyProposer", fields: [proposerUserId], references: [id])
  role             String         @default("EXPERT")
  wing             String         @default("RIGHT") // RIGHT or LEFT
  status           String         @default("PENDING")
  votes            CandidacyVote[]
  roundId          String?
  round            ElectionRound? @relation(fields: [roundId], references: [id])
  totalScore       Int            @default(0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@unique([domainId, candidateUserId])
  @@index([domainId])
  @@index([candidateUserId])
  @@index([proposerUserId])
  @@index([roundId])
}

model ElectionRound {
  id          String   @id @default(cuid())
  domainId    String
  domain      Domain   @relation(fields: [domainId], references: [id])
  wing        String   // RIGHT or LEFT
  startDate   DateTime @default(now())
  endDate     DateTime // End of the 1-week period
  status      String   @default("ACTIVE") // ACTIVE, COMPLETED, MEMBERS_ACTIVE, HEAD_ACTIVE, MEMBERS_COMPLETED, HEAD_COMPLETED
  candidacies ExpertCandidacy[]
  createdAt   DateTime @default(now())

  @@index([domainId])
}

model CandidacyVote {
  candidacyId  String
  candidacy    ExpertCandidacy @relation(fields: [candidacyId], references: [id], onDelete: Cascade)
  voterUserId  String
  voterUser    User            @relation("CandidacyVoteVoter", fields: [voterUserId], references: [id])
  score        Int             @default(0)
  createdAt    DateTime        @default(now())

  @@id([candidacyId, voterUserId])
  @@index([voterUserId])
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  password     String?
  name         String?
  image        String?
  bio          String?
  avatarBytes  Bytes?
  avatarMime   String?
  role         String        @default("USER")
  posts        Post[]
  adminVotes   Vote[]
  domainExperts DomainExpert[]
  expertCandidaciesProposed ExpertCandidacy[] @relation("ExpertCandidacyProposer")
  expertCandidaciesAsCandidate ExpertCandidacy[] @relation("ExpertCandidacyCandidate")
  candidacyVotes CandidacyVote[] @relation("CandidacyVoteVoter")
  userCourses  UserCourse[] @relation("UserCourseStudent")
  examinedCourses UserCourse[] @relation("UserCourseExaminer")
  examSessionsAsStudent ExamSession[] @relation("ExamSessionStudent")
  examSessionsAsExaminer ExamSession[] @relation("ExamSessionExaminer")
  sentMessages ChatMessage[] @relation("SentMessages")
  proposedCourses Course[] @relation("CourseProposer")
  courseVotes     CourseVote[] @relation("CourseVoteVoter")
  courseChapters  CourseChapter[]
  chapterVotes    ChapterVote[] @relation("ChapterVoteVoter")
  chapterProgress CourseChapterProgress[]
  chapterQuestions ChapterQuestion[]
  questionVotes    QuestionVote[]
  articles     Article[]
  comments     Comment[]
  commentReads CommentRead[]
  createdCommentPolls CommentPoll[]
  commentPollVotes    CommentPollVote[]
  coursePrerequisites CoursePrerequisite[]
  prerequisiteVotes   PrerequisiteVote[]
  domainPrerequisitesProposed DomainPrerequisite[] @relation("domainPrerequisitesProposed")
  domainPrerequisiteVotes      DomainPrerequisiteVote[] @relation("domainPrerequisiteVotes")
  domainInvestmentVotes        DomainInvestmentVote[]
  domainProposals              DomainProposal[] @relation("ProposedDomainProposals")
  domainProposalVotes          DomainProposalVote[]
  domainExchangeVotes          DomainExchangeVote[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Course {
  id          String   @id @default(cuid())
  title       String
  domainId    String
  domain      Domain   @relation(fields: [domainId], references: [id])
  description String?
  syllabus    Json?
  isActive    Boolean  @default(true)
  status      String   @default("PENDING")
  proposerId  String
  proposer    User     @relation("CourseProposer", fields: [proposerId], references: [id])
  userCourses UserCourse[]
  votes       CourseVote[]
  chapters    CourseChapter[]
  requirements DomainRequirement[]
  prerequisites CoursePrerequisite[] @relation("CoursePrerequisites")
  requiredBy    CoursePrerequisite[] @relation("CourseRequiredBy")
  researchPrerequisiteFor DomainPrerequisite[]
  examSessions ExamSession[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([domainId])
  @@index([isActive])
  @@index([status])
  @@index([proposerId])
}

model CourseVote {
  courseId   String
  course     Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  voterId    String
  voter      User   @relation("CourseVoteVoter", fields: [voterId], references: [id])
  score      Int    @default(0)
  createdAt  DateTime @default(now())

  @@id([courseId, voterId])
  @@index([voterId])
}

model CourseChapter {
  id          String   @id @default(cuid())
  title       String
  content     String   @default("")
  orderIndex  Int      @default(0)
  status      String   @default("PENDING")
  version     Int?
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  changeReason Json?
  originalChapterId String?
  originalChapter   CourseChapter? @relation("CourseChapterRevisions", fields: [originalChapterId], references: [id])
  revisions         CourseChapter[] @relation("CourseChapterRevisions")
  votes       ChapterVote[]
  progress    CourseChapterProgress[]
  questions   ChapterQuestion[]
  comments    Comment[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([courseId])
  @@index([authorId])
  @@index([status])
  @@index([originalChapterId])
  @@index([orderIndex])
  @@index([version])
}

model ChapterVote {
  chapterId String
  chapter   CourseChapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  voterId   String
  voter     User   @relation("ChapterVoteVoter", fields: [voterId], references: [id])
  score     Int    @default(0)
  createdAt DateTime @default(now())

  @@id([chapterId, voterId])
  @@index([voterId])
}

model CourseChapterProgress {
  userId    String
  user      User @relation(fields: [userId], references: [id])
  chapterId String
  chapter   CourseChapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  completedAt DateTime @default(now())

  @@id([userId, chapterId])
  @@index([chapterId])
}

model UserCourse {
  userId     String
  user       User     @relation("UserCourseStudent", fields: [userId], references: [id])
  courseId   String
  course     Course   @relation(fields: [courseId], references: [id])
  status     String   @default("ENROLLED")
  examinerId String?
  examiner   User?    @relation("UserCourseExaminer", fields: [examinerId], references: [id])
  score      Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@id([userId, courseId])
  @@index([courseId])
  @@index([status])
  @@index([examinerId])
}

model DomainRequirement {
  domainId         String
  domain           Domain @relation(fields: [domainId], references: [id])
  requiredCourseId String
  requiredCourse   Course @relation(fields: [requiredCourseId], references: [id])
  action           String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@id([domainId, requiredCourseId, action])
  @@index([requiredCourseId])
  @@index([action])
}

model ExamSession {
  id         String   @id @default(cuid())
  courseId   String
  course     Course   @relation(fields: [courseId], references: [id])
  studentId  String
  student    User     @relation("ExamSessionStudent", fields: [studentId], references: [id])
  examinerId String?
  examiner   User?    @relation("ExamSessionExaminer", fields: [examinerId], references: [id])
  meetLink   String?
  scheduledAt DateTime?
  status     String   @default("REQUESTED")
  score      Int?
  feedback   String?
  chatMessages ChatMessage[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([courseId])
  @@index([studentId])
  @@index([examinerId])
  @@index([scheduledAt])
  @@index([status])
}

model Post {
  id              String        @id @default(cuid())
  content         String
  articlesData    String?
  status          String        @default("PENDING")
  type            String        @default("TREE")
  version         Int?
  revisionNumber  Int?
  domainId        String?
  domain          Domain?       @relation(fields: [domainId], references: [id])
  relatedDomainIds String[]     @default([])
  authorId        String
  author          User          @relation(fields: [authorId], references: [id])
  changeReason    Json?
  changeSummary   String?
  originalPostId  String?
  originalPost    Post?         @relation("PostRevisions", fields: [originalPostId], references: [id])
  revisions       Post[]        @relation("PostRevisions")

  votes           Vote[]
  comments        Comment[]
  commentReads    CommentRead[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([createdAt])
  @@index([status])
  @@index([authorId])
  @@index([originalPostId])
  @@index([version])
  @@index([domainId])
}

model Vote {
  id        String   @id @default(cuid())
  score     Int
  postId    String
  post      Post     @relation(fields: [postId], references: [id])
  adminId   String
  admin     User     @relation(fields: [adminId], references: [id])
  domainId  String?
  createdAt DateTime @default(now())

  @@unique([postId, adminId, domainId])
  @@index([postId])
  @@index([adminId])
  @@index([createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  category  String?
  tag       String?
  postId    String?
  post      Post?     @relation(fields: [postId], references: [id])
  chapterId String?
  chapter   CourseChapter? @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  
  // Threaded replies support
  parentId  String?
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")

  // Optional poll attached to this comment
  poll      CommentPoll?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId])
  @@index([chapterId])
  @@index([category])
  @@index([tag])
  @@index([createdAt])
  @@index([authorId])
  @@index([parentId])
}

// Track last read time of a post per user (برای شمارش کامنت‌های خوانده‌نشده)
model CommentRead {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  postId     String
  post       Post     @relation(fields: [postId], references: [id])
  lastReadAt DateTime @default(now())

  @@unique([userId, postId])
}

model Article {
  id          String   @id @default(cuid())
  title       String
  content     String
  slug        String   @unique
  description String?
  status      String   @default("PUBLISHED")
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}

// Key-value settings storage (e.g., homepage header image url)
model Setting {
  key   String @id
  value String
}

// Poll models for comments
model CommentPoll {
  id           String              @id @default(cuid())
  commentId    String              @unique
  comment      Comment             @relation(fields: [commentId], references: [id])
  question     String?
  options      CommentPollOption[]
  votes        CommentPollVote[]
  createdById  String
  createdBy    User                @relation(fields: [createdById], references: [id])
  createdAt    DateTime            @default(now())

  @@index([createdById])
  @@index([createdAt])
}

model CommentPollOption {
  id      String       @id @default(cuid())
  text    String
  pollId  String
  poll    CommentPoll  @relation(fields: [pollId], references: [id])
  votes   CommentPollVote[]

  @@index([pollId])
}

model CommentPollVote {
  id        String             @id @default(cuid())
  pollId    String
  poll      CommentPoll        @relation(fields: [pollId], references: [id])
  optionId  String
  option    CommentPollOption  @relation(fields: [optionId], references: [id])
  voterId   String
  voter     User               @relation(fields: [voterId], references: [id])
  createdAt DateTime           @default(now())

  @@unique([pollId, voterId])
  @@index([pollId])
  @@index([optionId])
  @@index([voterId])
  @@index([createdAt])
}

model ChatMessage {
  id            String      @id @default(cuid())
  content       String
  senderId      String
  sender        User        @relation("SentMessages", fields: [senderId], references: [id])
  examSessionId String
  examSession   ExamSession @relation(fields: [examSessionId], references: [id], onDelete: Cascade)
  createdAt     DateTime    @default(now())

  @@index([senderId])
  @@index([examSessionId])
  @@index([createdAt])
}

model CoursePrerequisite {
  id                   String             @id @default(cuid())
  courseId             String
  course               Course             @relation("CoursePrerequisites", fields: [courseId], references: [id], onDelete: Cascade)
  prerequisiteCourseId String
  prerequisiteCourse   Course             @relation("CourseRequiredBy", fields: [prerequisiteCourseId], references: [id], onDelete: Cascade)
  type                 String             @default("STUDY")
  status               String             @default("PENDING")
  proposerId           String
  proposer             User               @relation(fields: [proposerId], references: [id])
  votes                PrerequisiteVote[]
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@unique([courseId, prerequisiteCourseId, type])
  @@index([courseId])
  @@index([prerequisiteCourseId])
  @@index([status])
}

model PrerequisiteVote {
  prerequisiteId String
  prerequisite   CoursePrerequisite @relation(fields: [prerequisiteId], references: [id], onDelete: Cascade)
  voterId        String
  voter          User               @relation(fields: [voterId], references: [id])
  score          Int                @default(0)
  createdAt      DateTime           @default(now())

  @@id([prerequisiteId, voterId])
  @@index([voterId])
}

model DomainExchangeProposal {
  id                         String   @id @default(cuid())
  proposerDomainId           String
  proposerDomain             Domain   @relation("ProposedExchanges", fields: [proposerDomainId], references: [id])
  targetDomainId             String
  targetDomain               Domain   @relation("ReceivedExchanges", fields: [targetDomainId], references: [id])
  percentageProposerToTarget Float
  percentageTargetToProposer Float
  status                     String   @default("PENDING") // PENDING, APPROVED, REJECTED
  votes                      DomainExchangeVote[]
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  @@index([proposerDomainId])
  @@index([targetDomainId])
  @@index([status])
}

model DomainExchangeVote {
  id         String                 @id @default(cuid())
  proposalId String
  proposal   DomainExchangeProposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  voterId    String
  voter      User                   @relation(fields: [voterId], references: [id])
  domainId   String                 // Which domain the voter is voting for
  score      Int                    @default(0)
  createdAt  DateTime               @default(now())

  @@unique([proposalId, voterId, domainId])
  @@index([proposalId])
  @@index([voterId])
}

model DomainProposal {
  id             String               @id @default(cuid())
  type           String               // CREATE, DELETE, RENAME
  name           String?
  newName        String?
  slug           String?
  description    String?
  reason         String?
  parentId       String?
  targetDomainId String?
  targetDomain   Domain?              @relation("TargetedProposals", fields: [targetDomainId], references: [id])
  status         String               @default("PENDING") // PENDING, APPROVED, REJECTED
  proposerId     String
  proposer       User                 @relation("ProposedDomainProposals", fields: [proposerId], references: [id])
  votes          DomainProposalVote[]
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  @@index([status])
}

model DomainProposalVote {
  proposalId String
  proposal   DomainProposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  voterId    String
  voter      User           @relation(fields: [voterId], references: [id])
  score      Int            @default(0)
  createdAt  DateTime       @default(now())

  @@id([proposalId, voterId])
  @@index([voterId])
}

model ChapterQuestion {
  id          String   @id @default(cuid())
  chapterId   String
  chapter     CourseChapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  question    String
  options     QuestionOption[]
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  votes       QuestionVote[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([chapterId])
  @@index([status])
}

model QuestionOption {
  id          String   @id @default(cuid())
  questionId  String
  question    ChapterQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  text        String
  isCorrect   Boolean  @default(false)

  @@index([questionId])
}

model QuestionVote {
  questionId  String
  question    ChapterQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  voterId     String
  voter       User     @relation(fields: [voterId], references: [id])
  score       Int      @default(0)
  createdAt   DateTime @default(now())

  @@id([questionId, voterId])
  @@index([voterId])
}

model DomainVotingShare {
  id              String   @id @default(cuid())
  domainId        String   // The domain whose voting power is being distributed
  domain          Domain   @relation("DomainShares", fields: [domainId], references: [id])
  ownerDomainId   String   // The domain that owns this share
  ownerDomain     Domain   @relation("OwnedShares", fields: [ownerDomainId], references: [id])
  ownerWing       String   @default("RIGHT") // RIGHT or LEFT
  domainWing      String   @default("RIGHT") // RIGHT or LEFT
  percentage      Float    // Percentage of total voting power (0-100)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([domainId, domainWing, ownerDomainId, ownerWing])
  @@index([domainId])
  @@index([ownerDomainId])
}

model DomainInvestment {
  id                String   @id @default(cuid())
  proposerDomainId  String
  proposerDomain    Domain   @relation("ProposedInvestments", fields: [proposerDomainId], references: [id])
  targetDomainId    String
  targetDomain      Domain   @relation("ReceivedInvestments", fields: [targetDomainId], references: [id])
  
  // The domain currency being invested (usually proposerDomainId, but can be a third domain if re-investing)
  investedDomainId  String?
  investedDomain    Domain?  @relation("InvestedInvestments", fields: [investedDomainId], references: [id])

  // Which wing of the proposer is giving the power
  proposerWing      String   @default("RIGHT") // RIGHT or LEFT
  // Which wing of the target is receiving the power
  targetWing        String   @default("RIGHT") // RIGHT or LEFT

  // Percentage of Proposer's power given to Target (Investment amount)
  percentageInvested    Float
  // Percentage of Target's power given to Proposer after duration (Interest/Return)
  percentageReturn      Float
  
  durationYears     Int      @default(1)
  contractNumber    Int      @default(autoincrement())
  status            String   @default("PENDING") // PENDING, APPROVED, REJECTED, ACTIVE, COMPLETED, RETURNED
  
  startDate         DateTime?
  endDate           DateTime?

  votes             DomainInvestmentVote[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([proposerDomainId])
  @@index([targetDomainId])
  @@index([status])
}

model DomainInvestmentVote {
  id            String           @id @default(cuid())
  investmentId  String
  investment    DomainInvestment @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  voterId       String
  voter         User             @relation(fields: [voterId], references: [id])
  score         Int              @default(0)
  domainId      String           // Which domain the voter is voting for (Proposer or Target)
  createdAt     DateTime         @default(now())

  @@unique([investmentId, voterId, domainId])
  @@index([investmentId])
  @@index([voterId])
}

model DomainPrerequisite {
  id                   String                 @id @default(cuid())
  domainId             String
  domain               Domain                 @relation(fields: [domainId], references: [id], onDelete: Cascade)
  courseId             String
  course               Course                 @relation(fields: [courseId], references: [id], onDelete: Cascade)
  status               String                 @default("PENDING")
  proposerId           String
  proposer             User                   @relation("domainPrerequisitesProposed", fields: [proposerId], references: [id])
  votes                DomainPrerequisiteVote[]
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt

  @@unique([domainId, courseId])
  @@index([domainId])
  @@index([courseId])
  @@index([status])
}

model DomainPrerequisiteVote {
  prerequisiteId String
  prerequisite   DomainPrerequisite @relation(fields: [prerequisiteId], references: [id], onDelete: Cascade)
  voterId        String
  voter          User               @relation("domainPrerequisiteVotes", fields: [voterId], references: [id])
  score          Int                @default(0)
  createdAt      DateTime           @default(now())

  @@id([prerequisiteId, voterId])
  @@index([voterId])
}
