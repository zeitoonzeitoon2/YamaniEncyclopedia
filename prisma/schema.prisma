// Prisma schema for SITEMAN

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Models (استفاده از String به‌جای enum برای سازگاری و سادگی)

model Domain {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?

  parentId    String?
  parent      Domain?  @relation("DomainHierarchy", fields: [parentId], references: [id])
  children    Domain[] @relation("DomainHierarchy")

  experts     DomainExpert[]
  expertCandidacies ExpertCandidacy[]
  courses     Course[]
  domainRequirements DomainRequirement[]
  posts       Post[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([parentId])
}

model DomainExpert {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  domainId  String
  domain    Domain   @relation(fields: [domainId], references: [id])
  role      String   @default("EXPERT")
  createdAt DateTime @default(now())

  @@unique([userId, domainId])
  @@index([domainId])
  @@index([userId])
}

model ExpertCandidacy {
  id              String         @id @default(cuid())
  domainId         String
  domain           Domain         @relation(fields: [domainId], references: [id])
  candidateUserId  String
  candidateUser    User           @relation("ExpertCandidacyCandidate", fields: [candidateUserId], references: [id])
  proposerUserId   String
  proposerUser     User           @relation("ExpertCandidacyProposer", fields: [proposerUserId], references: [id])
  role             String         @default("EXPERT")
  status           String         @default("PENDING")
  votes            CandidacyVote[]
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@unique([domainId, candidateUserId])
  @@index([domainId])
  @@index([candidateUserId])
  @@index([proposerUserId])
}

model CandidacyVote {
  candidacyId  String
  candidacy    ExpertCandidacy @relation(fields: [candidacyId], references: [id], onDelete: Cascade)
  voterUserId  String
  voterUser    User            @relation("CandidacyVoteVoter", fields: [voterUserId], references: [id])
  vote         String          @default("APPROVE")
  createdAt    DateTime        @default(now())

  @@id([candidacyId, voterUserId])
  @@index([voterUserId])
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  password     String?
  name         String?
  image        String?
  bio          String?
  avatarBytes  Bytes?
  avatarMime   String?
  role         String        @default("USER")
  posts        Post[]
  adminVotes   Vote[]
  domainExperts DomainExpert[]
  expertCandidaciesProposed ExpertCandidacy[] @relation("ExpertCandidacyProposer")
  expertCandidaciesAsCandidate ExpertCandidacy[] @relation("ExpertCandidacyCandidate")
  candidacyVotes CandidacyVote[] @relation("CandidacyVoteVoter")
  userCourses  UserCourse[] @relation("UserCourseStudent")
  examinedCourses UserCourse[] @relation("UserCourseExaminer")
  examSessionsAsStudent ExamSession[] @relation("ExamSessionStudent")
  examSessionsAsExaminer ExamSession[] @relation("ExamSessionExaminer")
  proposedCourses Course[] @relation("CourseProposer")
  courseVotes     CourseVote[] @relation("CourseVoteVoter")
  articles     Article[]
  comments     Comment[]
  commentReads CommentRead[]
  createdCommentPolls CommentPoll[]
  commentPollVotes    CommentPollVote[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Course {
  id          String   @id @default(cuid())
  title       String
  domainId    String
  domain      Domain   @relation(fields: [domainId], references: [id])
  description String?
  isActive    Boolean  @default(true)
  status      String   @default("PENDING")
  proposerId  String
  proposer    User     @relation("CourseProposer", fields: [proposerId], references: [id])
  userCourses UserCourse[]
  votes       CourseVote[]
  requirements DomainRequirement[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([domainId])
  @@index([isActive])
  @@index([status])
  @@index([proposerId])
}

model CourseVote {
  courseId   String
  course     Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  voterId    String
  voter      User   @relation("CourseVoteVoter", fields: [voterId], references: [id])
  vote       String @default("APPROVE")
  createdAt  DateTime @default(now())

  @@id([courseId, voterId])
  @@index([voterId])
}

model UserCourse {
  userId     String
  user       User     @relation("UserCourseStudent", fields: [userId], references: [id])
  courseId   String
  course     Course   @relation(fields: [courseId], references: [id])
  status     String   @default("ENROLLED")
  examinerId String?
  examiner   User?    @relation("UserCourseExaminer", fields: [examinerId], references: [id])
  score      Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@id([userId, courseId])
  @@index([courseId])
  @@index([status])
  @@index([examinerId])
}

model DomainRequirement {
  domainId         String
  domain           Domain @relation(fields: [domainId], references: [id])
  requiredCourseId String
  requiredCourse   Course @relation(fields: [requiredCourseId], references: [id])
  action           String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@id([domainId, requiredCourseId, action])
  @@index([requiredCourseId])
  @@index([action])
}

model ExamSession {
  id         String   @id @default(cuid())
  studentId  String
  student    User     @relation("ExamSessionStudent", fields: [studentId], references: [id])
  examinerId String
  examiner   User     @relation("ExamSessionExaminer", fields: [examinerId], references: [id])
  meetLink   String?
  scheduledAt DateTime
  status     String   @default("SCHEDULED")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([studentId])
  @@index([examinerId])
  @@index([scheduledAt])
  @@index([status])
}

model Post {
  id              String        @id @default(cuid())
  content         String
  articlesData    String?
  status          String        @default("PENDING")
  type            String        @default("TREE")
  version         Int?
  revisionNumber  Int?
  domainId        String?
  domain          Domain?       @relation(fields: [domainId], references: [id])
  relatedDomainIds String[]     @default([])
  authorId        String
  author          User          @relation(fields: [authorId], references: [id])

  originalPostId  String?
  originalPost    Post?         @relation("PostRevisions", fields: [originalPostId], references: [id])
  revisions       Post[]        @relation("PostRevisions")

  votes           Vote[]
  comments        Comment[]
  commentReads    CommentRead[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([createdAt])
  @@index([status])
  @@index([authorId])
  @@index([originalPostId])
  @@index([version])
  @@index([domainId])
}

model Vote {
  id        String   @id @default(cuid())
  score     Int
  postId    String
  post      Post     @relation(fields: [postId], references: [id])
  adminId   String
  admin     User     @relation(fields: [adminId], references: [id])
  createdAt DateTime @default(now())

  @@unique([postId, adminId])
  @@index([postId])
  @@index([adminId])
  @@index([createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  category  String?
  tag       String?
  postId    String
  post      Post     @relation(fields: [postId], references: [id])
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  
  // Threaded replies support
  parentId  String?
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")

  // Optional poll attached to this comment
  poll      CommentPoll?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId])
  @@index([category])
  @@index([tag])
  @@index([createdAt])
  @@index([authorId])
  @@index([parentId])
}

// Track last read time of a post per user (برای شمارش کامنت‌های خوانده‌نشده)
model CommentRead {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  postId     String
  post       Post     @relation(fields: [postId], references: [id])
  lastReadAt DateTime @default(now())

  @@unique([userId, postId])
}

model Article {
  id          String   @id @default(cuid())
  title       String
  content     String
  slug        String   @unique
  description String?
  status      String   @default("PUBLISHED")
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}

// Key-value settings storage (e.g., homepage header image url)
model Setting {
  key   String @id
  value String
}

// Poll models for comments
model CommentPoll {
  id           String              @id @default(cuid())
  commentId    String              @unique
  comment      Comment             @relation(fields: [commentId], references: [id])
  question     String?
  options      CommentPollOption[]
  votes        CommentPollVote[]
  createdById  String
  createdBy    User                @relation(fields: [createdById], references: [id])
  createdAt    DateTime            @default(now())

  @@index([createdById])
  @@index([createdAt])
}

model CommentPollOption {
  id      String       @id @default(cuid())
  text    String
  pollId  String
  poll    CommentPoll  @relation(fields: [pollId], references: [id])
  votes   CommentPollVote[]

  @@index([pollId])
}

model CommentPollVote {
  id        String             @id @default(cuid())
  pollId    String
  poll      CommentPoll        @relation(fields: [pollId], references: [id])
  optionId  String
  option    CommentPollOption  @relation(fields: [optionId], references: [id])
  voterId   String
  voter     User               @relation(fields: [voterId], references: [id])
  createdAt DateTime           @default(now())

  @@unique([pollId, voterId])
  @@index([pollId])
  @@index([optionId])
  @@index([voterId])
  @@index([createdAt])
}
